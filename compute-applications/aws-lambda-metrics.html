<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWS Lambda Invocationメトリクスの解説</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            background-color: #232F3E;
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 8px 8px 0 0;
        }
        .intro {
            background-color: #FF9900;
            color: #232F3E;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .metrics-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 30px;
        }
        .metric-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            width: calc(50% - 20px);
            transition: transform 0.3s ease;
        }
        .metric-card:hover {
            transform: translateY(-5px);
        }
        .metric-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        .metric-icon {
            width: 40px;
            height: 40px;
            background-color: #FF9900;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            color: white;
            font-weight: bold;
            font-size: 20px;
        }
        .metric-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #232F3E;
        }
        .metric-description {
            font-size: 0.95rem;
            line-height: 1.5;
        }
        .visual-section {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 30px;
        }
        .chart-container {
            height: 300px;
            margin: 20px 0;
        }
        .best-practices {
            background-color: #E6F7FF;
            border-radius: 8px;
            padding: 20px;
            margin-top: 30px;
        }
        .practice-item {
            margin-bottom: 15px;
            padding-left: 25px;
            position: relative;
        }
        .practice-item:before {
            content: "✓";
            position: absolute;
            left: 0;
            color: #FF9900;
            font-weight: bold;
        }
        .alert-section {
            background-color: #FFEBEE;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            border-left: 4px solid #F44336;
        }
        footer {
            background-color: #232F3E;
            color: white;
            text-align: center;
            padding: 15px;
            border-radius: 0 0 8px 8px;
            font-size: 0.9rem;
        }
        @media (max-width: 768px) {
            .metric-card {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>AWS Lambda Invocationメトリクス解説</h1>
            <p>サーバーレスアプリケーションのパフォーマンスを監視・最適化するための重要指標</p>
        </header>

        <div class="intro">
            <h2>Lambdaの呼び出しメトリクスとは？</h2>
            <p>Lambda関数の実行に関する様々な指標を測定し、アプリケーションの健全性、パフォーマンス、コストを最適化するための重要なデータです。</p>
        </div>

        <div class="metrics-container">
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-icon">1</div>
                    <div class="metric-title">Invocations（呼び出し回数）</div>
                </div>
                <div class="metric-description">
                    <p>Lambda関数が呼び出された回数を示します。APIゲートウェイ、S3イベント、定期的なスケジュールなど、様々なソースからの呼び出しがカウントされます。</p>
                    <p><strong>重要度:</strong> ⭐⭐⭐⭐⭐</p>
                    <p><strong>単位:</strong> Count</p>
                    <p><strong>確認ポイント:</strong> 想定外の呼び出し回数の急増や減少は、問題の兆候かもしれません。</p>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-icon">2</div>
                    <div class="metric-title">Errors（エラー）</div>
                </div>
                <div class="metric-description">
                    <p>関数の実行中に発生したエラーの数を示します。コード内の例外、タイムアウト、権限の問題などが含まれます。</p>
                    <p><strong>重要度:</strong> ⭐⭐⭐⭐⭐</p>
                    <p><strong>単位:</strong> Count</p>
                    <p><strong>確認ポイント:</strong> エラー率（Errors/Invocations）を監視し、通常は5%未満に保つべきです。</p>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-icon">3</div>
                    <div class="metric-title">Duration（実行時間）</div>
                </div>
                <div class="metric-description">
                    <p>関数がコードの実行に費やした時間を測定します。初期化時間は含まれず、純粋なコード実行時間のみです。</p>
                    <p><strong>重要度:</strong> ⭐⭐⭐⭐</p>
                    <p><strong>単位:</strong> ミリ秒</p>
                    <p><strong>確認ポイント:</strong> タイムアウト制限に近づいていないか、また実行時間の急な増加はパフォーマンスの問題を示す可能性があります。</p>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-icon">4</div>
                    <div class="metric-title">Throttles（スロットル）</div>
                </div>
                <div class="metric-description">
                    <p>同時実行の制限によりスロットルされた呼び出しの数です。AWSはアカウントごとにデフォルトで1000の同時実行数を設定しています。</p>
                    <p><strong>重要度:</strong> ⭐⭐⭐⭐</p>
                    <p><strong>単位:</strong> Count</p>
                    <p><strong>確認ポイント:</strong> スロットルが発生する場合は、同時実行制限の引き上げをリクエストするか、関数のアーキテクチャを見直す必要があります。</p>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-icon">5</div>
                    <div class="metric-title">ConcurrentExecutions（同時実行数）</div>
                </div>
                <div class="metric-description">
                    <p>特定の時点で同時に実行されているLambda関数のインスタンス数を示します。</p>
                    <p><strong>重要度:</strong> ⭐⭐⭐</p>
                    <p><strong>単位:</strong> Count</p>
                    <p><strong>確認ポイント:</strong> 予約済み同時実行数を設定している場合は、その使用率を監視します。</p>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-icon">6</div>
                    <div class="metric-title">IteratorAge（イテレータ年齢）</div>
                </div>
                <div class="metric-description">
                    <p>ストリームベースの呼び出し（KinesisやDynamoDB Streams）において、レコードがストリームに追加されてからLambdaで処理されるまでの時間です。</p>
                    <p><strong>重要度:</strong> ⭐⭐⭐</p>
                    <p><strong>単位:</strong> ミリ秒</p>
                    <p><strong>確認ポイント:</strong> 処理が遅れている場合は、関数のパフォーマンスか、シャードの数を見直す必要があります。</p>
                </div>
            </div>
        </div>

        <div class="visual-section">
            <h2>Invocationメトリクスの関係性</h2>
            <div class="chart-container">
                <svg viewBox="0 0 800 300" style="width: 100%; height: 100%;">
                    <!-- 背景グリッド -->
                    <g>
                        <line x1="100" y1="50" x2="100" y2="250" stroke="#ddd" stroke-width="1" />
                        <line x1="200" y1="50" x2="200" y2="250" stroke="#ddd" stroke-width="1" />
                        <line x1="300" y1="50" x2="300" y2="250" stroke="#ddd" stroke-width="1" />
                        <line x1="400" y1="50" x2="400" y2="250" stroke="#ddd" stroke-width="1" />
                        <line x1="500" y1="50" x2="500" y2="250" stroke="#ddd" stroke-width="1" />
                        <line x1="600" y1="50" x2="600" y2="250" stroke="#ddd" stroke-width="1" />
                        <line x1="700" y1="50" x2="700" y2="250" stroke="#ddd" stroke-width="1" />
                        
                        <line x1="50" y1="50" x2="750" y2="50" stroke="#ddd" stroke-width="1" />
                        <line x1="50" y1="100" x2="750" y2="100" stroke="#ddd" stroke-width="1" />
                        <line x1="50" y1="150" x2="750" y2="150" stroke="#ddd" stroke-width="1" />
                        <line x1="50" y1="200" x2="750" y2="200" stroke="#ddd" stroke-width="1" />
                        <line x1="50" y1="250" x2="750" y2="250" stroke="#ddd" stroke-width="1" />
                    </g>
                    
                    <!-- 軸 -->
                    <line x1="50" y1="250" x2="750" y2="250" stroke="#333" stroke-width="2" />
                    <line x1="50" y1="50" x2="50" y2="250" stroke="#333" stroke-width="2" />
                    
                    <!-- X軸ラベル - 時間 -->
                    <text x="100" y="270" text-anchor="middle" font-size="12">9:00</text>
                    <text x="200" y="270" text-anchor="middle" font-size="12">10:00</text>
                    <text x="300" y="270" text-anchor="middle" font-size="12">11:00</text>
                    <text x="400" y="270" text-anchor="middle" font-size="12">12:00</text>
                    <text x="500" y="270" text-anchor="middle" font-size="12">13:00</text>
                    <text x="600" y="270" text-anchor="middle" font-size="12">14:00</text>
                    <text x="700" y="270" text-anchor="middle" font-size="12">15:00</text>
                    
                    <!-- Y軸ラベル - 数値 -->
                    <text x="40" y="250" text-anchor="end" font-size="12">0</text>
                    <text x="40" y="200" text-anchor="end" font-size="12">25</text>
                    <text x="40" y="150" text-anchor="end" font-size="12">50</text>
                    <text x="40" y="100" text-anchor="end" font-size="12">75</text>
                    <text x="40" y="50" text-anchor="end" font-size="12">100</text>
                    
                    <!-- グラフタイトル -->
                    <text x="400" y="25" text-anchor="middle" font-size="16" font-weight="bold">1日のLambda呼び出しパターン</text>
                    
                    <!-- 呼び出し回数 (Invocations) - 青線 -->
                    <path d="M50,230 L100,210 L200,180 L300,150 L400,100 L500,120 L600,170 L700,210 L750,230" 
                          fill="none" stroke="#4285F4" stroke-width="3" />
                    
                    <!-- エラー (Errors) - 赤線 -->
                    <path d="M50,245 L100,242 L200,240 L300,220 L400,190 L500,235 L600,240 L700,243 L750,245" 
                          fill="none" stroke="#EA4335" stroke-width="3" />
                    
                    <!-- スロットル (Throttles) - 黄色線 -->
                    <path d="M50,250 L100,250 L200,250 L300,250 L400,170 L500,240 L600,250 L700,250 L750,250" 
                          fill="none" stroke="#FBBC05" stroke-width="3" />
                    
                    <!-- 凡例 -->
                    <rect x="550" y="60" width="15" height="15" fill="#4285F4" />
                    <text x="575" y="73" font-size="14">Invocations（呼び出し）</text>
                    
                    <rect x="550" y="85" width="15" height="15" fill="#EA4335" />
                    <text x="575" y="98" font-size="14">Errors（エラー）</text>
                    
                    <rect x="550" y="110" width="15" height="15" fill="#FBBC05" />
                    <text x="575" y="123" font-size="14">Throttles（スロットル）</text>
                </svg>
            </div>
        </div>

        <div class="alert-section">
            <h3>⚠️ 注意ポイント:</h3>
            <p>昼のピーク時（12:00頃）に、呼び出し回数が急増し、それに伴いエラーとスロットルも増加しています。これはリソース制限に達している可能性を示唆しています。</p>
        </div>

        <div class="visual-section">
            <h2>Invocationメトリクスの監視方法</h2>
            <div class="chart-container">
                <svg viewBox="0 0 800 300" style="width: 100%; height: 100%;">
                    <!-- ダッシュボード表現 -->
                    <rect x="50" y="50" width="700" height="200" fill="#F5F5F5" stroke="#CCCCCC" stroke-width="1" />
                    
                    <!-- ヘッダー部分 -->
                    <rect x="50" y="50" width="700" height="40" fill="#232F3E" />
                    <text x="375" y="75" text-anchor="middle" font-size="16" fill="white">AWS CloudWatch Lambda Metricsダッシュボード</text>
                    
                    <!-- メトリクスウィジェット -->
                    <rect x="70" y="110" width="200" height="120" rx="5" ry="5" fill="white" stroke="#CCCCCC" />
                    <text x="170" y="130" text-anchor="middle" font-size="14" font-weight="bold">Invocations</text>
                    <text x="170" y="180" text-anchor="middle" font-size="24" fill="#4285F4">2,457</text>
                    <text x="170" y="210" text-anchor="middle" font-size="12" fill="#666">前日比 +12%</text>
                    
                    <rect x="300" y="110" width="200" height="120" rx="5" ry="5" fill="white" stroke="#CCCCCC" />
                    <text x="400" y="130" text-anchor="middle" font-size="14" font-weight="bold">Errors</text>
                    <text x="400" y="180" text-anchor="middle" font-size="24" fill="#EA4335">73</text>
                    <text x="400" y="210" text-anchor="middle" font-size="12" fill="#666">エラー率: 2.97%</text>
                    
                    <rect x="530" y="110" width="200" height="120" rx="5" ry="5" fill="white" stroke="#CCCCCC" />
                    <text x="630" y="130" text-anchor="middle" font-size="14" font-weight="bold">Avg. Duration</text>
                    <text x="630" y="180" text-anchor="middle" font-size="24" fill="#34A853">187ms</text>
                    <text x="630" y="210" text-anchor="middle" font-size="12" fill="#666">前日比 -5ms</text>
                </svg>
            </div>
        </div>

        <div class="best-practices">
            <h2>Lambda Invocationメトリクスの活用ベストプラクティス</h2>
            <div class="practice-item">
                <h3>アラームの設定</h3>
                <p>エラー率が5%を超えた場合や、スロットルが発生した場合に通知を受け取るようにCloudWatchアラームを設定しましょう。</p>
            </div>
            <div class="practice-item">
                <h3>ダッシュボードの作成</h3>
                <p>関連するメトリクスを一覧できるカスタムダッシュボードを作成し、定期的に確認する習慣をつけましょう。</p>
            </div>
            <div class="practice-item">
                <h3>予約済み同時実行数の設定</h3>
                <p>重要な関数には、予約済み同時実行数を設定して、スロットルを防止しましょう。</p>
            </div>
            <div class="practice-item">
                <h3>コールドスタート対策</h3>
                <p>Duration メトリクスに大きなばらつきがある場合は、予備容量（Provisioned Concurrency）の設定を検討しましょう。</p>
            </div>
            <div class="practice-item">
                <h3>リトライ戦略の最適化</h3>
                <p>非同期呼び出しの場合、適切なリトライ回数と最大経過時間を設定しましょう。</p>
            </div>
        </div>

        <footer>
            <p>© 2025 AWS Lambda Metrics Guide</p>
        </footer>
    </div>
</body>
</html>